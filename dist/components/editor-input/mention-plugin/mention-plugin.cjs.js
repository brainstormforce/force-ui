"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const h=require("react/jsx-runtime"),r=require("react"),Q=require("@lexical/react/LexicalComposerContext"),V=require("@lexical/react/LexicalTypeaheadMenuPlugin"),y=require("./mention-node.cjs.js"),J=require("./mention-option-item.cjs.js"),X=require("./mention-hooks.cjs.js"),$=require("./mention-combobox.cjs.js"),a=require("lexical"),Z=require("@lexical/utils"),f=require("@floating-ui/react"),z=({optionsArray:T,by:M="name",size:C="md",trigger:A="@",menuComponent:k=$.default,menuItemComponent:b=$.default.Item,autoSpace:I=!0})=>{const{y:q,refs:i,strategy:v}=f.useFloating({placement:"bottom",strategy:"absolute",middleware:[f.offset(8),f.autoPlacement(),f.shift(),f.flip()],whileElementsMounted:f.autoUpdate}),m=r.useRef(!1),w=r.useRef(null),N=`\\.,\\+\\*\\?\\$\\@\\|#{}\\(\\)\\^\\-\\[\\]\\\\/!%'"~=<>_:;`,E=[A].join(""),S="[^"+E+N+"\\s]",D="(?:\\.[ |$]| |["+N+"]|)",P=75,F=new RegExp(`(^|\\s|\\()([${E}]((?:${S}${D}){0,${P}}))$`),j=50,K=new RegExp(`(^|\\s|\\()([${E}]((?:${S}){0,${j}}))$`),W=t=>{let e=F.exec(t);if(e===null&&(e=K.exec(t)),e!==null){const c=e[1],s=e[3];if(s.length>=0)return{leadOffset:e.index+c.length,matchingString:s,replaceableString:e[2]}}return null},[o]=Q.useLexicalComposerContext(),[Y,R]=r.useState(null),[p,d]=r.useState(!1),x=X.default(T,Y,M),G=r.useCallback((t,e,c)=>{o.update(()=>{const s=y.$createMentionNode(t.data,M,C);e&&e.replace(s),c(),d(!1)})},[o]),g=r.useMemo(()=>x.map(t=>new J.default(t)),[o,x]),L=r.useCallback(t=>{if(!I)return!1;const{key:e,ctrlKey:c,metaKey:s}=t;if(c||s||e===" "||e.length>1||m.current)return m.current&&(m.current=!1),!1;const n=a.$getSelection(),{focus:u,anchor:l}=n,[O]=n.getNodes();if(!l||!u||l?.key!==u?.key||l?.offset!==u?.offset||!O)return!1;if(y.$isMentionNode(O)){const B=a.$createTextNode(" ");return O.insertAfter(B),!0}return!1},[o,A,I]),H=r.useCallback(t=>{const{key:e}=t;return e==="Backspace"?(m.current=!0,!0):!1},[m]),_=r.useCallback(()=>{d(!0)},[]),U=r.useCallback(()=>(_(),!1),[]);return r.useEffect(()=>{if(o)return Z.mergeRegister(o.registerCommand(a.KEY_DOWN_COMMAND,L,a.COMMAND_PRIORITY_LOW),o.registerCommand(a.KEY_BACKSPACE_COMMAND,H,a.COMMAND_PRIORITY_LOW),o.registerCommand(a.FOCUS_COMMAND,U,a.COMMAND_PRIORITY_LOW))},[o,L]),r.useEffect(()=>{if(!o)return;const t=o.getRootElement()?.parentElement?.parentElement;t&&i.setReference(t)},[o,i]),r.useEffect(()=>{p||d(g.length>0)},[g]),r.useEffect(()=>{if(!p)return;const t=s=>{const n=s.target,u=o.getRootElement(),l=i.floating.current;u&&!u.contains(n)&&l&&!l.contains(n)&&(d(!1),R(null))},e=()=>{setTimeout(()=>{const s=o.getRootElement(),n=i.floating.current;if(s){const l=s.ownerDocument.activeElement;n&&(!l||!n.contains(l))&&(d(!1),R(null))}},100)};document.addEventListener("mousedown",t);const c=o.getRootElement();return c&&c.addEventListener("blur",e,!0),()=>{document.removeEventListener("mousedown",t),c&&c.removeEventListener("blur",e,!0)}},[p,o,i.floating]),h.jsx(V.LexicalTypeaheadMenuPlugin,{onOpen:_,onQueryChange:R,onSelectOption:G,triggerFn:W,options:g,menuRenderFn:(t,{selectedIndex:e,selectOptionAndCleanUp:c,setHighlightedIndex:s})=>!p||!t.current||!g?.length?null:h.jsx(k,{className:"w-full",size:C,ref:n=>{i.setFloating(n),w.current=n},style:{position:v,top:q??0,left:-2,width:"calc(100% + 4px)"},children:g.map((n,u)=>h.jsx(b,{ref:n.ref,size:C,selected:u===e,onMouseEnter:()=>{s(u)},onClick:()=>c(n),children:typeof n.data=="string"?n.data:n.data?.[M]},u))})})};exports.default=z;
//# sourceMappingURL=mention-plugin.cjs.js.map
